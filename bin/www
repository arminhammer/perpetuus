#!/usr/bin/env node
var bodyParser = require('body-parser');
var debug = require('debug')('expressapp');
var express = require('express');
var app = express();

var town = require('ghost-town')();

if(town.isMaster) {
    console.log('This is the master thread');
    app.set('port', process.env.PORT || 9000);
    app.use(bodyParser.json());
    app.use(bodyParser.urlencoded({
        extended: true
    }));
    app.get('/', function(req, res) {
        res.send('OK!');
    });
    app.post('/', function(req, res) {
        console.log(req.body);
        town.queue(req.body, false, function(err, data) {
            if(err) console.log('There was an error: ' + err);
            console.log('Data: ');
            console.log(data);
            res.json(data);
        })
    });
    var server = app.listen(app.get('port'), function() {
        console.log('Express server listening on port ' + server.address().port);
    });
} else {
    console.log('This is the worker thread');
    town.on('queue', function(page, data, next) {
        console.log('Got a work unit queue');
        console.log(data);
        page.open(data.url, function(status) {
            if ( status === "success" ) {
                page.includeJs("http://ajax.googleapis.com/ajax/libs/jquery/1.6.1/jquery.min.js", function() {

                })
            }
            next(null, status);
        });
    })
}

